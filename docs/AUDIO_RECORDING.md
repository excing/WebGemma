# 录音功能实现

## 🎯 功能概述

Gemma AI 助手现在支持实时录音功能，用户可以直接录制音频并发送给支持多模态的 AI 模型进行处理。

## ✨ 核心特性

### 1. 实时录音
- **一键录音**：点击麦克风图标即可开始录音
- **实时反馈**：录音过程中显示动画和时长
- **高质量音频**：支持回声消除、噪音抑制等音频优化

### 2. 录音控制
- **暂停/继续**：录音过程中可以暂停和继续
- **实时时长**：显示当前录音时长
- **取消录音**：可以随时取消录音

### 3. 音频处理
- **自动格式化**：自动选择最佳音频格式
- **文件转换**：将录音转换为文件格式
- **即时发送**：录音完成后自动添加到消息附件

### 4. 浏览器兼容
- **权限管理**：自动请求麦克风权限
- **格式支持**：支持多种音频格式（WebM、MP4、WAV等）
- **兼容性检查**：自动检测浏览器支持情况

## 🎯 Gemma 音频处理优化

### 1. 符合 Gemma 3n 规范
根据 [Google Gemma 音频文档](https://ai.google.dev/gemma/docs/capabilities/audio)，我们的实现完全符合 Gemma 3n 的音频处理要求：

- **采样率**：16kHz（Gemma 推荐的音频处理率）
- **声道**：单声道（Gemma 要求，多声道会自动转换）
- **数据格式**：32位浮点数，范围 [-1, 1]
- **帧长度**：32毫秒帧（Gemma 音频分词器规格）
- **最大长度**：推荐30秒以内（可根据上下文窗口调整）

### 2. 自动音频处理
应用会自动将录音转换为 Gemma 兼容格式：

```typescript
// 自动处理流程
1. 录音 → 原始音频文件
2. 解码 → AudioBuffer
3. 转换 → 单声道 16kHz Float32Array
4. 标准化 → 范围 [-1, 1]
5. 传递 → MediaPipe LLM
```

### 3. 支持的音频任务
- **语音转文字 (STT)**：将语音转录为文本
- **自动语音翻译 (AST)**：将语音直接翻译为其他语言文本
- **多语言支持**：支持100+种语言的语音处理

## 🛠️ 技术实现

### 1. AudioRecorder 工具类
```typescript
export class AudioRecorder {
  // 核心功能
  async startRecording(): Promise<void>
  pauseRecording(): void
  resumeRecording(): void
  stopRecording(): void
  cancelRecording(): void
  
  // 状态管理
  getState(): RecordingState
  onStateChange?: (state: RecordingState) => void
  onDataAvailable?: (audioBlob: Blob) => void
  onError?: (error: string) => void
}
```

### 2. 录音状态接口
```typescript
interface RecordingState {
  isRecording: boolean;    // 是否正在录音
  isPaused: boolean;       // 是否已暂停
  duration: number;        // 录音时长（秒）
  error: string | null;    // 错误信息
}
```

### 3. 音频配置
```typescript
const audioConstraints = {
  echoCancellation: true,    // 回声消除
  noiseSuppression: true,    // 噪音抑制
  autoGainControl: true,     // 自动增益控制
  sampleRate: 44100          // 采样率
};
```

## 🎮 使用方法

### 基础录音流程
1. **开始录音**：点击消息输入框旁的麦克风图标
2. **授权访问**：首次使用时允许浏览器访问麦克风
3. **录音控制**：使用暂停/继续按钮控制录音
4. **完成录音**：点击停止按钮完成录音
5. **发送消息**：录音自动添加到附件，可配合文本一起发送

### 录音界面说明
- **红色圆圈**：录音状态指示器，录音时会有脉冲动画
- **时长显示**：MM:SS 格式显示当前录音时长
- **控制按钮**：
  - 🟡 暂停/继续按钮
  - 🟢 完成录音按钮
  - ⚫ 取消录音按钮

### 最佳实践
- **环境安静**：在相对安静的环境中录音效果更好
- **距离适中**：保持与麦克风适中的距离
- **分段录音**：长内容可以分段录音，避免单次录音过长
- **测试音质**：首次使用时可以录制短音频测试音质

## 📊 技术规格

### 支持的音频格式（Gemma 优化）
| 格式 | MIME Type | 浏览器支持 | Gemma 兼容性 | 推荐度 |
|------|-----------|------------|--------------|--------|
| WAV | audio/wav | 大部分浏览器 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| WebM | audio/webm;codecs=opus | Chrome, Firefox | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| WebM | audio/webm | Chrome, Firefox | ⭐⭐⭐ | ⭐⭐⭐ |
| MP4 | audio/mp4 | Safari, Chrome | ⭐⭐⭐ | ⭐⭐⭐ |

### 音频质量设置（Gemma 优化）
- **采样率**：16 kHz（Gemma 推荐，语音优化）
- **比特率**：64 kbps（语音优化，减少文件大小）
- **声道**：单声道（Gemma 要求）
- **编码**：WAV（最兼容）或 Opus（WebM）
- **数据格式**：32位浮点，范围 [-1, 1]

### 浏览器兼容性
| 浏览器 | 版本要求 | 录音支持 | 音频格式 |
|--------|----------|----------|----------|
| Chrome | 47+ | ✅ | WebM, MP4 |
| Firefox | 29+ | ✅ | WebM |
| Safari | 14.1+ | ✅ | MP4, WAV |
| Edge | 79+ | ✅ | WebM, MP4 |

## 🔧 配置选项

### 默认设置（Gemma 优化）
```typescript
const defaultConfig = {
  sampleRate: 16000,         // 16kHz 采样率（Gemma 推荐）
  audioBitsPerSecond: 64000, // 64kbps 比特率（语音优化）
  channelCount: 1,           // 单声道（Gemma 要求）
  echoCancellation: true,    // 回声消除
  noiseSuppression: true,    // 噪音抑制
  autoGainControl: true      // 自动增益控制
};
```

### 可调整参数
- **音频质量**：可以调整比特率和采样率
- **音频处理**：可以开关各种音频优化功能
- **录音时长**：可以设置最大录音时长限制
- **文件命名**：自动生成带时间戳的文件名

## 🎯 使用场景

### 1. 语音问答
```
用户：[录音] "请帮我解释一下量子计算的基本原理"
AI：根据您的语音问题，量子计算是...
```

### 2. 多语言交流
```
用户：[录音] "Bonjour, comment allez-vous?"
AI：您好！我很好，谢谢您用法语问候...
```

### 3. 音频分析
```
用户：[录音] 上传一段音乐片段
AI：这段音频听起来像是古典音乐...
```

### 4. 语音转文字
```
用户：[录音] 长段语音内容
AI：我听到您说的是："..."，让我来回应...
```

## 🔍 故障排除

### 常见问题

**Q: 点击录音按钮没有反应**
A: 检查浏览器是否支持录音功能，确认已授权麦克风访问

**Q: 录音质量不好**
A: 检查麦克风设备，确保环境相对安静，调整与麦克风的距离

**Q: 录音文件过大**
A: 可以分段录音，或者在设置中降低音频质量

**Q: 浏览器提示权限被拒绝**
A: 在浏览器设置中允许网站访问麦克风，或重新授权

### 调试方法
1. **检查权限**：确认浏览器已授权麦克风访问
2. **测试设备**：在系统设置中测试麦克风是否正常工作
3. **查看控制台**：打开开发者工具查看错误信息
4. **尝试其他浏览器**：测试不同浏览器的兼容性

## 🚀 未来改进

### 计划中的功能
1. **音频预处理**：实时音频降噪和增强
2. **语音识别**：本地语音转文字功能
3. **音频可视化**：录音时显示音频波形
4. **音频编辑**：简单的音频剪辑功能

### 性能优化
1. **压缩算法**：更高效的音频压缩
2. **流式处理**：支持长时间录音的流式处理
3. **缓存机制**：优化音频数据的内存使用
4. **后台处理**：后台音频处理不影响界面响应

## 📱 移动端支持

### iOS Safari
- **支持版本**：iOS 14.3+
- **特殊说明**：需要用户手势触发录音
- **限制**：某些音频格式可能不支持

### Android Chrome
- **支持版本**：Chrome 47+
- **特殊说明**：完整支持所有功能
- **优化**：针对移动设备优化了界面

### 移动端最佳实践
- **触摸友好**：按钮大小适合触摸操作
- **电池优化**：避免长时间录音消耗电池
- **网络考虑**：在移动网络下注意音频文件大小

录音功能为 Gemma AI 助手增加了强大的语音交互能力，让用户可以更自然地与 AI 进行对话！🎤
